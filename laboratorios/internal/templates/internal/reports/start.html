{% extends 'internal/base_internal.html' %}


{% block page_content %}
<div class="row border-bottom white-bg dashboard-header">
    <div class="col-md-6">
        <h2><strong>Reportes</strong></h2>
    </div>
</div>
<div class="wrapper wrapper-content animated fadeInRight"> {% csrf_token %}
    <h3><strong>Criteria y Filtros</strong></h3>
    <label class="col-sm-2 control-label">Rango de Fechas</label>
    <div class="col-sm-4">
    <div id="reportrange" class="pull-right" style="background: #fff; cursor: pointer; padding: 5px 10px; border: 1px solid #ccc; width: 100%">
        <i class="glyphicon glyphicon-calendar fa fa-calendar"></i>&nbsp;
        <span></span> <b class="caret"></b>
    </div>
    </div>
    <br>
    <br>
    <br>
    <div id=criteriaInsertion class="col-md-4">
        <label class="control-label">Criterios de agrupación</label>
        <br>
        <br>
        <br> 
    </div>
    <div id=filterInsertion class="col-md-8">
        <label class="control-label">Filtros</label>
        <br>
        <br>
        <br>
    </div>
    <div id=submitInfo class="col-md-6">
        <a class="btn btn-primary pull-right" onclick=sendMe() >
                <i class="fa fa-plus"></i>
                Generar Reporte
              </a>
        <br><br><br><br>
    </div>
    
</div>
{% endblock page_content %}


{% block custom_js %}
<script type="text/javascript" src="{{static('js/icheck.min.js')}}"></script>
<script type="test/javascript" src="{{static('js/chosen.jquery.js')}}"></script>
<script type="text/javascript" src="{{static('js/moment.js')}}"></script>
<script type="text/javascript" src="//cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.js"></script>
<link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.css" />
<script type="text/javascript">
$(function() {

    var start = moment().subtract(29, 'days');
    var end = moment();

    function cb(start, end) {
        $('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
    }

    $('#reportrange').daterangepicker({
        startDate: start,
        endDate: end,
        ranges: {
           'Today': [moment(), moment()],
           'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
           'Last 7 Days': [moment().subtract(6, 'days'), moment()],
           'Last 30 Days': [moment().subtract(29, 'days'), moment()],
           'This Month': [moment().startOf('month'), moment().endOf('month')],
           'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
        }
    }, cb);

    cb(start, end);
    
});
</script>
<script type="text/javascript">
$(document).ready(function(){
    function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
var csrftoken = getCookie('csrftoken');
    console.log(csrftoken);
    var criteria_string = {{ criteria_string | safe }};
    console.log(criteria_string);
    for(var k=0; k<criteria_string.length; k++){
        tag='';
        tag=tag+'<label class="col-sm-2 control-label">'+criteria_string[k]+'</label>';
            tag=tag+'<div class="col-md-1">'
            tag=tag+'<input id=p_'+k+' type="checkbox" name="input" value="check" onclick=checkMe(this.id) > Seleccionar Criterio ';
            tag=tag+'</div>';
            tag=tag+'<br><br><br><br>';
        $('#criteriaInsertion').append(tag);
    }





    var filter = {{ filter | safe}};
    var filter_string = {{ filter_string | safe}};
    var data_list = {{ data_list | safe}};    
    for(var i=0;i<filter.length;i++){
        console.log(data_list[filter[i]]);
        // For the css to actually work, we need to append html with all the sections closed beforehand
        tag='';
        tag=tag+'<label class="col-sm-1 control-label">'+filter_string[filter[i]]+'</label>';
            tag=tag+'<div class="col-md-1">'
            tag=tag+'<input id=s_'+i+' type="checkbox" name="input" value="check" onclick=checkMe(this.id) > Seleccionar Filtro ';
            tag=tag+'</div>';
            tag=tag+'<div class="col-md-4">';
                            tag=tag+'<div id=list_'+i.toString()+' class="form-group hidden">';
                                tag=tag+'<label>Seleccione l@s '+ filter_string[filter[i]]+'s: </label>';
                                tag=tag+'<div class="table-responsive">';
                                    tag=tag+'<table class="table table-striped table-bordered permission_table">';
                                      tag=tag+'<thead>';
                                        tag=tag+'<tr>';
                                          tag=tag+'<th>Nombre de '+filter_string[filter[i]]+'</th>';   
                                          tag=tag+'<th>Selección</th>';
                                        tag=tag+'</tr>';
                                      tag=tag+'</thead>';
                                      tag=tag+'<tbody id=body_'+i.toString()+' >';
            for (var j=0;j<data_list[filter[i]].length;j++){
            tag=tag                              +'<tr>';
            tag=tag                                +'<td>'+ data_list[filter[i]][j]+'</td>';
            tag=tag                                +'<td><input id=s_input_'+i.toString()+'_'+j.toString() +' type="checkbox" name="value" class="i-checks checkbox_role"></td>';
            tag=tag                              +'</tr>';
            
        }
                                      tag=tag+'</tbody>';
                                    tag=tag+'</table>';
                                
                            tag=tag+'</div>';
                        tag=tag+'</div>';
                tag=tag+'</div>';
            tag=tag+'<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>';
        
        
        $('#filterInsertion').append(tag);
    }
    
    checkMe=function(id){
        console.log(document.getElementById(id).checked);
        // Check the other one for same filter
        console.log(id[0]);
        if (id[0]=='p'){
            //document.getElementById(id.replace('p','s')).checked=false;

            // Check if another filter is checked as main one
            for(var i=0;i<filter.length;i++){
                if (i != parseInt(id.replace('p_',''))){
                    document.getElementById('p_'+i.toString()).checked=false;
                }
            }
        }else{
            //document.getElementById(id.replace('s','p')).checked=false;
            if (document.getElementById(id).checked == false){
                $('#list_'+id[2]).addClass('hidden');
            }else{
                $('#list_'+id[2]).removeClass('hidden');
            }
        }
    }
    
    sendMe=function(){
        var sending_string='';
        var criteria_index = 0;
        for(var i=0;i<criteria_string.length;i++){
            if (document.getElementById('p_'+i.toString()).checked){
                
                break;
            }else{
                criteria_index++;
            }
        }
        sending_string=sending_string+criteria_index.toString()+'_'

        for(var i=0;i<filter.length;i++){
            if (document.getElementById('s_'+i.toString()).checked){
                sending_string=sending_string+'es_1_';
                for(var j=0;j<data_list[filter[i]].length;j++){
                    if (document.getElementById('s_input_'+i.toString()+'_'+j.toString()).checked){
                        sending_string=sending_string+'e_'+i.toString()+'_'+j.toString()+'_';
                    }
                }
                sending_string=sending_string+'ef_';
            }else{
                sending_string=sending_string+'es_0_';
            }
        }
        console.log(sending_string);
        uploadData(sending_string);
    }


    function uploadData(insert_data){
        var data = {js_data: insert_data,
                    csrfmiddlewaretoken: csrftoken};
        $.post('/internal/reports/start', JSON.stringify(data), function(response){
            console.log(data['csrfmiddlewaretoken']);
            window.location.replace('/internal/reports/results/'+insert_data);
            });
    }




    
});
</script>

{% endblock custom_js %}
