{% extends 'internal/base_internal.html' %}

{% block title %}{{ super() }} | Solicitudes{% endblock title %}

{% block custom_css %}
<style>
.alert { display: none; }
</style>
{% endblock custom_css %}

{% block page_content %}
<div class="row border-bottom white-bg dashboard-header">
  <div class="col-md-6">
    <h2><strong>Detalle Solicitud</strong></h2>
  </div>
</div>

<div class="wrapper wrapper-content animated fadeInRight">
  <div class="col-lg-12">
    <div class="ibox float-e-margins">
      <div class="ibox-content">
        {{ form.errors }}
        <form id='requestform' action="{{ url('internal:servicerequest.edit',pk=pk) }}" method="post" data-toggle="validator">
          {% csrf_token %}
            <div class="row">
              <div class="col-lg-6">
              <div class="form-group">
                <label>Cliente</label>
                <select disabled name="client" data-error="Este campo es obligatorio" required="" id="id_client" class="form-control">
                  {% for client in clients %}
                      <option value="{{ client.id }}">{{ client.user.first_name }} {{ client.user.last_name }}</option>
                  {% endfor %}
                </select>
                 <div class="help-block with-errors"></div>
              </div>
              <div class="form-group">
                <label>Supervisor</label>
                <select disabled name="supervisor" data-error="Este campo es obligatorio" required="" id="id_supervisor" class="form-control">
                  {% for employee in employees %}
                      <option {{ 'selected' if (service_request.supervisor.id == employee.id) }} value="{{ employee.id }}">{{ employee.user.first_name }} {{ employee.user.last_name }}</option>
                  {% endfor %}
                </select>
                  <div class="help-block with-errors"></div>
              </div>
              <div class="form-group">
                <label>Estado</label>
                <select disabled name="state" data-error="Este campo es obligatorio" required="" id="id_state" class="form-control">
                  {% for state in states %}
                      <option {{ 'selected' if (service_request.state.id == state.id) }} value="{{ state.id }}">{{ state.description }}</option>
                  {% endfor %}
                </select>
                  <div class="help-block with-errors"></div>
              </div>
              <div class="form-group">
                <label>Observaciones</label>
                <input disabled value="{{ service_request.observations }}" type="text" name="observations" data-error="Este campo es obligatorio" required="" id="id_observations" class="form-control">
                  <div class="help-block with-errors"></div>
              </div>
              <div class="form-group">
                <label>Duracion Esperada</label>
                <input disabled value="{{ service_request.expected_duration }}" type="number" name="expected_duration" data-error="Este campo es obligatorio" required="" id="id_expected_duration" class="form-control">
                  <div class="help-block with-errors"></div>
              </div>
            </div>
            <div class="col-lg-6">
              <div class="form-group">
                <div hidden="True" class="i-checks"><label class=""> <div class="iradio_square-green" style="position: relative;"><input  {{ 'checked' if (service_request.external_provider) }} id="check_service_provider" type="checkbox" value="option1" name="a" style="position: absolute; opacity: 0;"><ins class="iCheck-helper" style="position: absolute; top: 0%; left: 0%; display: block; width: 100%; height: 100%; margin: 0px; padding: 0px; background: rgb(255, 255, 255); border: 0px; opacity: 0;"></ins></div> <i></i>Tercerizar Servicio</label></div>
              </div>
              <div class="form-group" id="servide_provider_input" style="display: none;">
                <label>Proveedores</label>
                <select disabled name="external_provider" data-error="Este campo es obligatorio" id="id_state" class="form-control">
                  <option value="" >---------</option>
                  {% for external_provider in external_providers %}
                      <option value="{{ external_provider.id }}" {% if service_request.external_provider.id == external_provider.id %} selected{% endif %}>{{ external_provider.name }}</option>
                  {% endfor %}
                </select>
                  <div class="help-block with-errors"></div>
              </div>
            </div>
          </div>
        {% for sample in samples %}
        <div class="row">
          <div class="col-lg-12">
            <table class="table table-bordered table-hover sample-table">
              <thead>
                <tr>
                  <th>Id</th>
                  <th>Muestra</th>
                  <th>Tipo de Muestra</th>
                  <th>Nombre de Ensayo: {{ essays[loop.index-1] }}</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>{{ sample.id }}</td>
                  <td>{{ sample.name }}</td>
                  <td>{{ sample.sample_type.name }}</td>
                  <td>
                    <table class="table table-bordered table-hover essaymethod-table">
                      <thead>
                        <tr>
                          {% for essay_method_fill in essays_methods[loop.index-1] %}
                          <th>{{ essay_method_fill.essay_method.name }}</th>
                          {% endfor %}
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          {% for essay_method_active in essay_methods_chosen_forms[loop.index-1] %}
                          <td>{{ essay_method_active.as_p() }}</td>
                          {% endfor%}
                        </tr>
                      </tbody>
                    </table>
                  </td>
                  <td>
                    <a class="btn-white btn btn-xs" href="{{ url('internal:servicerequest.edit_sample',pk,sample.id) }}">Editar</a>
                    <a class="btn-white btn btn-xs" href="{{ url('internal:servicerequest.delete_sample',pk,sample.id) }}">Eliminar</a>
                    <a class="btn btn-white btn-xs btn-assign-employee"
                       data-toggle="modal"
                       data-target="#assign-employee-modal"
                       data-url="{{ url('internal:servicerequest.assign_employee', request_id=pk, sample_id=sample.id) }}">
                       <span>
                        Asignar Empleado
                       </span>
                    </a>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        {% endfor %}
        <div class="row">
          <div class="col-lg-6 col-lg-offset-3">
            <div class="text-center">
              <a href="{{ url('internal:servicerequest.edit',pk)}}" class="btn btn-primary">Editar</a>
              <a href="{{ url('internal:servicerequest.index')}}" class="btn btn-primary">Atrás</a>
              <input type=button value="Previous Page" onClick="javascript:history.go(-1);">

            </div>
          </div>



        </form>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal inmodal" id="assign-employee-modal" tabindex="-1" role="dialog" aria-hidden="true">
</div>
{% endblock page_content %}

{% block custom_js %}
<script>
if($('#check_service_provider')[0].checked)
  $('#servide_provider_input').show();
else
  $('#servide_provider_input').hide();

$('.iradio_square-green').click(function(){
  if($('#check_service_provider')[0].checked)
    $('#servide_provider_input').hide();
  else
    $('#servide_provider_input').show();
});

$('#assign-employee-modal').on('show.bs.modal', function (e) {
  var $btn = $(e.relatedTarget);
  var $modal = $(this);
  var url = $btn.data('url');
  $.ajax({
    url: url,
  }).done(function (response) {
    $modal.html(response);
    $('#assign-employee-form').validator();
  });
});

$(document).on('submit', '#assign-employee-form', function (e) {
  e.preventDefault();

  var $form = $(e.target);
  var $modal = $('#assign-employee-modal');

  $.ajax({
    url: $form.get(0).action,
    method: $form.get(0).method,
    data: $form.serialize(),
  }).done(function (response) {
    $modal.find('.alert').hide();
    if (!response.success) {
      $modal.find('.form-errors').html(response.errors).fadeIn();
      return;
    }
    $modal.find('.form-success').html(response.message).fadeIn();
    setTimeout(function () {
      $modal.modal('hide');
    }, 1500);
  });
});

$('#assign-employee-modal').on('hidden.bs.modal', function () {
  var $modal = $(this);
  $modal.find('.alert').hide();
});

$('.btn-assign-employee').each(function (index, elem) {
  var $btn = $(elem);
  update_assign_btn($btn);
});

$('.essaymethod-table [type="checkbox"]').on('change', function () {
  var $btn = $(this).parents('.sample-table').find('.btn-assign-employee');
  update_assign_btn($btn);
});

function update_assign_btn($btn) {
  var $sampleTable = $btn.parents('.sample-table');
  var $essayMethodTable = $sampleTable.find('.essaymethod-table');
  var $checkedMethods = $essayMethodTable.find('[type="checkbox"]:checked');

  if ($checkedMethods.length == 0) {
    $btn.prop('disabled', true).find('span').tooltip({
      title: 'Debe seleccionar un método de ensayo',
    });
  } else {
    $btn.prop('disabled', false).find('span').tooltip('destroy');
  }
}
</script>

{% endblock custom_js %}
