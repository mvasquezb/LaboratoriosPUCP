{% extends 'internal/base_internal.html' %}

{% block title %}{{ super() }} | Laboratorios{% endblock title %}

{% block custom_css %}

{% endblock custom_css %}

{% block page_content %}

<div class="row border-bottom white-bg dashboard-header">
    <div class="col-md-6">
        <h2><strong>Crear Laboratorio</strong></h2>
    </div>
</div>

<!--
<form id="djform" action="{{ url('internal:laboratory.create') }}" method="POST">
{% csrf_token %}
{{ form.as_p() }}
<input type="submit" value="submit">
  </form>
-->

  <div class="wrapper wrapper-content animated fadeInRight" >
    <div class="row">
      <div class="col-lg-12">
      <div class="ibox float-e-margins">
        <div class="ibox-content">
          {{ form.errors }}
          <form action="{{ url('internal:laboratory.create') }}" data-toggle="validator" id="form" method="POST">
            <div class="row">
              {% csrf_token %}
              <div class="form-group">
                <label>Nombre de laboratorio (*)</label>
                <input type="text" maxlength="50" class="form-control" id="laboratory_name" required data-error="El nombre es obligatorio" placeholder="Ingrese nombre de laboratorio">
                <span class="help-block m-b-none">Hasta 50 caracteres permitidos</span>
                <div class="help-block with-errors"></div>
              </div>

              <div class="form-group">
                <label>Capacidad máxima de empleados (*)</label>
                <input class="form-control" name="laboratory_capacity" id="capacity" type="number" min="5" max="10" value="5" onkeydown="return FilterNmberInput(event)" onpaste="handlePaste(event)" required data-error="Ingrese un valor válido para capacidad de personal">
                <span class="help-block m-b-none">Mínima cantidad será cinco (5) y máxima será diez (10)</span>
                <div class="help-block with-errors"></div>
              </div>
            </div>
            <div class="row">
              <div class="form-group">
                  <label>Seleccione al personal para el nuevo laboratorio</label><br>
                  <span>Podrá seleccionar tantos usuarios como la capacidad máxima se lo permita</span>
                  <div class="table-responsive">
                    <table class="table table-striped table-bordered">
                      <thead>
                        <tr>
                          <th>Nombre del Empleado</th>
                          <th>Correo</th>
                          <th>Selección</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for user in users %}
                          <tr>
                            <td>{{ user }}</td>
                            <td>{{ user.user.email }}</td>
                            <td>
                              <input type="checkbox" class="checkbox_users" data-name="{{ user }}" data-id="{{ user.pk }}">
                            </td>
                          </tr>
                        {% endfor %}
                      </tbody>

                    </table>
                    <div class="form-group">
                      <label>Responsable del laboratorio</label>
                        <select class="form-control m-b" id="comboBox">
                          <option selected>-- Ningún responsable seleccionado --</option>
                        </select>
                    </div>
                  </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-12">
                <label>Seleccione los inventarios</label>
                <div class="table-responsive">
                  <table class="table table-striped table-bordered">
                    <thead>
                      <tr>
                        <th>Nombre de inventario</th>
                        <th>Ubicación</th>
                        <th>Selección</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for inventory in inventories %}
                        <tr>
                          <td>{{ inventory.name }}</td>
                          <td>{{ inventory.location }}</td>
                          <td>
                            <input type="checkbox" class="checkbox_inventory i-checks" data-id="{{ inventory.pk }}">
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-12">
                <label>Seleccione los tipos de pruebas realizables para este laboratorio </label>
                <div class="table-responsive">
                  <table class="table table-striped table-bordered">
                    <thead>
                      <tr>
                        <th>Nombre de Prueba</th>
                        <th>Descripción</th>
                        <th>Precio (S/.)</th>
                        <th>Selección</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for essaymethod in essaymethods %}
                        <tr>
                          <td>{{ essaymethod.name }}</td>
                          <td>{{ essaymethod.description }}</td>
                          <td>{{ essaymethod.price }}</td>
                          <td>
                            <input type="checkbox" class="checkbox_essay i-checks" data-id="{{ essaymethod.pk }}">
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            <p><strong>(*) Campos obligatorios</strong></p>
            <div class="col-md-offset-4 col-md-4 text-center">
              <input type="submit" class="btn btn-primary" name="registrar" id="register_button" value="Registrar">
              <a href="{{ url('internal:laboratory.index') }}" class="btn btn-white">Cancelar</a>
            </div>
          </form>
        </div>

      </div>
    </div>
    </div>
  </div>


<div class="message-container hidden">
  <ul class="messages">
    {% for message in messages %}
    <li{% if message.tags %} data-tags="{{ message.tags }}"{% endif %}>{{ message }}</li>
    {% endfor %}
  </ul>
</div>
{% endblock page_content %}

{% block custom_js %}
<script>
  if ($('.message-container .messages li')) {
  var msg = $('.message-container .messages li').first();
  showToastr(msg.text(), msg.data('tags'));
}
</script>

<script>
  //var selected_users = [];
  var capacity_users;
  var counting = 0;
  var to_out;

  function handlePaste (e) {
    var clipboardData, pastedData;

    // Get pasted data via clipboard API
    clipboardData = e.clipboardData || window.clipboardData;
    pastedData = clipboardData.getData('Text').toUpperCase();

    if(pastedData.indexOf('E')>-1) {
        //alert('found an E');
        e.stopPropagation();
        e.preventDefault();
    }
};

  function FilterNmberInput(event) {
    var keyCode = ('which' in event) ? event.which : event.keyCode;

    isNotWanted = (keyCode == 69 || keyCode == 101);
    return !isNotWanted;
};

  //cuando se invalida data
  $('#capacity').on('invalid.bs.validator', function(){
    //$('#users_selection').hide();
    $('input.checkbox_users:checkbox').prop('checked', false);
    //selected_users.length = 0;
    $('input.checkbox_users:checkbox').prop('disabled', true);
    counting = 0;
    //borrar todos los campos en responsable de laboratorio
    $('#comboBox').empty();
    $('#comboBox').append($('<option>', {
          text: "-- Ningún Responsable Seleccionado --"
        }));
  });

  //cuando se valida la data
  $('#form').on('valid.bs.validator', function(){
    //$('#users_selection').show();
    $('input.checkbox_users:checkbox').prop('disabled', false);
    capacity_users = $("#capacity").val();
  });

  var value = $('#capacity').val();
  $('#capacity').on('keyup change click',function(){
    if (this.value !== value){
      $('input.checkbox_users:checkbox').prop('checked', false);
      counting = 0;
      $('#comboBox').empty();
      $('#comboBox').append($('<option>', {
          text: "-- Ningún Responsable Seleccionado --"
        }));
      capacity_users = $(this).val();
    }
  });

  //cuando se clickea en los checkboxes de usuarios de laboratorio
  $('input.checkbox_users:checkbox').on('change', function() {
    if($(this).is(':checked')) {
      //selected_users.push(String(this.id));
      if ((counting + 1) <= capacity_users){
        counting = counting + 1;
        //selected_users.push(String(this.id)); //añadimos en el arreglo los ids de los usuarios //seleccionados
        $('#comboBox').append($('<option>', {
          text: $(this).data('name'),
          'data-id': $(this).data('id'),
        }));
      } else {
        $(this).prop('checked', false);
      }
    } else { //si el checkbox es unchecked
      //selected_users.splice(selected_users.indexOf(String(this.id)), 1); //quitamos del arreglo los ids de los usuarios los cuales fueron unchecked
      counting = counting - 1;
      to_out = $(this).data('name');
      var to_remove = $('#comboBox option').filter(function(){
        return $(this).text() == to_out;
      });
      $(to_remove).remove();
    }
  });

  //cuando se clickea en el boton registrar primero se arma la estructura de django para que se
  //reciba en el view
  $('#form').on('submit', function(evt){
    //evt.preventDefault();
    var $form = $(this);
    var name = $('<input>', {
      name: 'name',
      type: 'hidden',
      value: $('#laboratory_name').val(),
    });
    $form.append(name);

    var capacity = $('<input>', {
      name: 'capacity',
      type: 'hidden',
      value: $('#capacity').val(),
    });
    $form.append(capacity);


    $('input.checkbox_users:checkbox:checked').each(function(){
      var employee = $('<input>', {
        name: 'employees',
        type: 'hidden',
        value: $(this).data('id'),
      });
      $form.append(employee);
    });

    if ($('#comboBox option:selected').text() == '-- Ningún Responsable Seleccionado --'){
      //$form.append($('<input>').attr('name', 'supervisor').val());
    } else {
      var supervisor = $('<input>', {
        name: 'supervisor',
        type: 'hidden',
        value: $('#comboBox option:selected').data('id'),
      });
      $form.append(supervisor);
    }


    $('input.checkbox_inventory:checkbox:checked').each(function(){
      var inventory = $('<input>', {
        name: 'inventory',
        type: 'hidden',
        value: $(this).data('id'),
      });
      $form.append(inventory);
    });


    $('input.checkbox_essay:checkbox:checked').each(function(){
      var essay = $('<input>', {
        name: 'essay_methods',
        type: 'hidden',
        value: $(this).data('id'),
      });
      $form.append(essay);
    });

    //$form.submit();
    //console.log($form.serialize());
  });
  </script>
{% endblock custom_js %}
