{% extends 'internal/base_internal.html' %}

{% block title %}{{ super() }} | Inicio{% endblock title %}

{% block custom_css %}

{% endblock custom_css %}

{% block page_content %}

<div class="row border-bottom white-bg dashboard-header">
    <div class="col-md-3">
        <h2><strong>Detalle Laboratorio</strong></h2>
    </div>
</div>

  <div class="wrapper wrapper-content animated fadeInRight" >
    <div class="row">
      <div class="col-lg-12">
      <div class="ibox float-e-margins">
        <div class="ibox-content">
          {{ form.errors }}
          <form action="{{ url('internal:laboratory.edit', pk=laboratory.pk) }}" data-toggle="validator" id="form" method="POST">
            <div class="row">
              {% csrf_token %}
              <div class="col-md-12 form-group">
                <label>Nombre de laboratorio</label>
                <input type="text" maxlength="50" disabled class="form-control" id="laboratory_name" required data-error="El nombre es obligatorio" placeholder="Ingrese nombre de laboratorio" value="{{ laboratory.name }}">
                <div class="help-block with-errors"></div>
              </div>

              <!--
              <div class="form-group">
                <label>Capacidad máxima de empleados</label>
                <input class="form-control" disabled name="laboratory_capacity" onkeydown="return FilterNmberInput(event)" onpaste="handlePaste(event)" id="capacity" type="number" min="5" max="10" value="{{ laboratory.capacity }}" required data-error="Ingrese un valor válido para capacidad de personal">
                <div class="help-block with-errors"></div>
              </div>
              -->
            </div>
            <div class="row">
              <div class="col-md-12 form-group">
                  {% if selected_users|length >0 %}
                  <label>Personal del laboratorio</label>
                  <div class="table-responsive">
                    <table class="table table-striped table-bordered table-hover dataTables-example" >
                      <thead>
                        <tr>
                          <th>Nombre del empleado</th>
                          <th>Correo</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for selected_user in selected_users %}
                          <tr class="gradeX">
                            <td>{{ selected_user }}</td>
                            <td>{{ selected_user.user.email }}</td>
                          </tr>
                        {% endfor %}
                      </tbody>

                    </table>
                    <div class="form-group">
                      <label>Responsable de laboratorio</label>
                        <select class="form-control m-b" id="comboBox" disabled>
                          <option selected>-- Ningún Responsable Seleccionado --</option>
                          {% for selected_user in selected_users %}
                            {% if selected_user == laboratory.supervisor %}
                              <option id="{{ selected_user.pk }}" selected>{{ selected_user }}</option>
                            {% else %}
                              <option id="{{ selected_user.pk }}" >{{ selected_user }}</option>
                            {% endif %}
                          {% endfor %}
                        </select>
                    </div>
                  </div>
                  {% else %}
                  <label>No hay personal asignado a este laboratorio</label>
                  {% endif %}
              </div>
            </div>
            <!--
            <div class="row">
              <div class="form-group">
                <label>Horas de Servicio</label>
                  <select class="form-control m-b" id="comboBox_service_hours" disabled>
                    {% for service_hour in all_service_hours %}
                      {% if selected_service_hours.pk == service_hour.pk %}
                        <option id="{{ service_hour.pk }}" selected>De {{ service_hour.start_time }} a {{ service_hour.end_time }}</option>
                      {% else %}
                        <option id="{{ service_hour.pk }}">De {{ service_hour.start_time }} a {{ service_hour.end_time }}</option>
                      {% endif %}
                    {% endfor %}
                  </select>
              </div>
            </div>
            -->
            <div class="row">
              <div class="col-md-12 form-group">
                {% if selected_inventories|length > 0 %}
                <label>Inventarios para el laboratorio</label>
                <div class="table-responsive">
                  <table class="table table-striped table-bordered table-hover dataTables-example" >
                    <thead>
                      <tr>
                        <th>Nombre de Inventario</th>
                        <th>Ubicación</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for inventory in selected_inventories %}
                        <tr class="gradeX">
                          <td>{{ inventory.name }}</td>
                          <td>{{ inventory.location }}</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                {% else %}
                <label>No hay inventarios asignados a este laboratorio</label>
                {% endif %}
              </div>
            </div>

            <div class="row">
              <div class="col-md-12 form-group">
              {% if selected_essaymethods|length > 0 %}
              <label>Pruebas realizables para este laboratorio </label>
              <div class="table-responsive">
                <table class="table table-striped table-bordered table-hover dataTables-example" >
                  <thead>
                    <tr>
                      <th>Nombre de Prueba</th>
                      <th>Descripción</th>
                      <th>Precio(S/.)</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for essaymethod in selected_essaymethods %}
                      <tr class="gradeX">
                        <td>{{ essaymethod.name }}</td>
                        <td>{{ essaymethod.description }}</td>
                        <td>{{ essaymethod.price }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              {% else %}
              <label>No hay pruebas realizables asignadas a este laboratorio</label>
              {% endif %}
              </div>
            </div>
            <div class="col-md-offset-4">
              {% if not laboratory.deleted %}
                <a  href="{{ url('internal:laboratory.edit', laboratory.id) }}"  class="btn btn-primary">
                  <i class="fa fa-pencil-square-o" aria-hidden="true"></i>
                  Editar
                </a>
              {% endif %}
              <a href="{{ url('internal:laboratory.index') }}" class="btn btn-white">Regresar</a>
            </div>
          </form>
        </div>

      </div>
    </div>
    </div>
  </div>

{% endblock page_content %}

{% block custom_js %}
<script type="text/javascript">
  //var selected_users = [];
  var capacity_users;
  var counting = {{ selected_users|length }};
  var to_out;

  function handlePaste (e) {
    var clipboardData, pastedData;

    // Get pasted data via clipboard API
    clipboardData = e.clipboardData || window.clipboardData;
    pastedData = clipboardData.getData('Text').toUpperCase();

    if(pastedData.indexOf('E')>-1) {
        //alert('found an E');
        e.stopPropagation();
        e.preventDefault();
    }
};

  function FilterNmberInput(event) {
    var keyCode = ('which' in event) ? event.which : event.keyCode;

    isNotWanted = (keyCode == 69 || keyCode == 101);
    return !isNotWanted;
};

  //cuando se invalida data
  $('#capacity').on('invalid.bs.validator', function(){
    //$('#users_selection').hide();
    $('input:checkbox[id^="checkbox_users"]').prop('checked', false);
    //selected_users.length = 0;
    $('input:checkbox[id^="checkbox_users"]').attr('disabled', 'true');
    counting = 0;
    //borrar todos los campos en responsable de laboratorio
    $('#comboBox').empty();
    $('#comboBox').append($('<option>', {
          text: "-- Ningún Responsable Seleccionado --"
        }));
  });

  //cuando se valida la data
  $('#form').on('valid.bs.validator', function(){
    //$('#users_selection').show();
    $('input:checkbox[id^="checkbox_users"]').removeAttr('disabled');
    capacity_users = document.getElementById("capacity").value;
  });

  var value = $('#capacity').val();
  $('#capacity').bind('keyup change click',function(){
    if (this.value < value){
      $('input:checkbox[id^="checkbox_users"]').prop('checked', false);
      counting = 0;
      $('#comboBox').empty();
      $('#comboBox').append($('<option>', {
          text: "-- Ningún Responsable Seleccionado --"
        }));
      capacity_users = document.getElementById("capacity").value;
      }
  });

  //cuando se clickea en los checkboxes de usuarios de laboratorio
  $('input:checkbox[id^="checkbox_users"]').click(function() {
    if($(this).is(':checked')) {
      //selected_users.push(String(this.id));
      if ((counting + 1) <= capacity_users){
        counting = counting + 1;
        //selected_users.push(String(this.id)); //añadimos en el arreglo los ids de los usuarios //seleccionados
        $('#comboBox').append($('<option>', {
          text: String(this.name)
        }).attr('id',String(this.className)));
        console.log(String(this.name));
      } else {
        this.checked = false;
      }
    } else { //si el checkbox es unchecked
      //selected_users.splice(selected_users.indexOf(String(this.id)), 1); //quitamos del arreglo los ids de los usuarios los cuales fueron unchecked
      counting = counting - 1;
      to_out = String(this.name);
      $('#comboBox option').each(function(){
        if ($(this).text() == to_out){
          $(this).remove();
        }
      });
    }
  });

  //cuando se clickea en el boton registrar
  $('#form').on('submit', function(evt){
    //evt.preventDefault();
    var $form = $(this);

    var name = $('<input>', {
      name: 'name',
      type: 'hidden'
    }).val($('#laboratory_name').val());
    $form.append(name);

    var capacity = $('<input>', {
      name: 'capacity',
      type: 'hidden'
    }).val($('#capacity').val());
    $form.append(capacity);


    $('input:checkbox[id^="checkbox_users"]:checked').each(function(){
      var employee = $('<input>', {
        name: 'employees',
        type: 'hidden'
      }).val($(this).attr('class'));
      $form.append(employee);
    });



    if ($('#comboBox option:selected').text == '-- Ningún Responsable Seleccionado --'){
      //$form.append($('<input>').attr('name', 'supervisor').val());
    } else {
      var supervisor = $('<input>', {
        name: 'supervisor',
        type: 'hidden'
      }).val($('#comboBox option:selected').attr('id'));
      $form.append(supervisor);
    }

    var service_hours = $('<input>', {
      name: 'service_hours',
      type: 'hidden'
    }).val($('#comboBox_service_hours option:selected').attr('id'));
    $form.append(service_hours);


    $('input:checkbox[id^="checkbox_inventory"]:checked').each(function(){
      var inventory = $('<input>', {
        name: 'inventory',
        type: 'hidden'
      }).val($(this).attr('name'));
      $form.append(inventory);
    });


    $('input:checkbox[id^="checkbox_essay"]:checked').each(function(){
      var essay = $('<input>', {
        name: 'essay_methods',
        type: 'hidden'
      }).val($(this).attr('name'));
      $form.append(essay);
    });

    //$form.submit();
    //console.log($form.serialize());
  });

  $('#djform').on('submit', function(e) {
    //e.preventDefault();
    //console.log($(this).serialize());
    //$(this).submit();
  });
  </script>
{% endblock custom_js %}
